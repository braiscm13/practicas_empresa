SELECT 
	U.MATRICULA, 
	U.KM_RECORRIDOS, 
	U.HORAS_MARCHA, 
	((U.DIAS_TOTALES * 24)- U.HORAS_MARCHA) AS HORAS_INACTIVIDAD, 
	(U.KM_RECORRIDOS / U.DIAS_TOTALES) AS MEDIA_DIARIA_KM, 
	(U.HORAS_MARCHA / U.DIAS_TOTALES) AS MEDIA_DIARIA_HM 
FROM 
	(
		SELECT 
			MATRICULA,  
			KM_RECORRIDOS, 
			HORAS_MARCHA, (? - ?) AS DIAS_TOTALES 
		FROM 
			(
				SELECT 
					MATRICULA, 
					(KM_FIN - KM_INI) AS KM_RECORRIDOS,
					(
						SELECT 
							NVL(SUM(MINUTOS)/60,0)  
						FROM 
							CDACTIVIDADES A
						WHERE 
							A.NUMREQ = ?
							AND U.MATRICULA = A.MATRICULA 
							AND A.FEC_COMIENZO >= ? 
							AND A.FEC_COMIENZO < ?
							AND A.TPACTIVIDAD = 4
							AND RANURA = 0
					) AS HORAS_MARCHA
				FROM 
					( 
						SELECT 
							MATRICULA, 
							MIN(KM_INI) AS KM_INI, 
							MAX(KM_FIN) AS KM_FIN
						FROM 
							CDUSO_VEHICULO U
						WHERE 
							U.FECINI > ? 
							AND U.FECINI < ? 
							AND U.NUMREQ = ? 
							AND U.KM_FIN > 0
						GROUP BY 
							MATRICULA 
					) U 
			)
	) U,
	CDVVEHICULO_CONT C
WHERE 
	U.MATRICULA = C.MATRICULA 
	AND C.CG_CONTRATO = ?
	AND C.F_BAJA IS NULL
	#SQLDELEG#